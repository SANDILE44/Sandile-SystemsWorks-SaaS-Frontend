<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Payment - Sandile SystemsWorks</title>
    <link rel="stylesheet" href="css/styles.css" />
  </head>

  <body>
    <main style="max-width: 600px; margin: 50px auto; text-align: center">
      <h1>Payment Required</h1>
      <p>Your free access has ended. Please subscribe to continue.</p>

      <div id="payBox" style="margin: 18px 0"></div>

      <p style="margin-top: 20px">
        <a href="dashboard.html">Back</a>
      </p>
    </main>

    <!-- ✅ REQUIRED GLOBALS FIRST (ORDER MATTERS) -->
    <script src="js/config.js"></script>
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>

    <!-- ✅ PAGE LOGIC AFTER globals are loaded -->
    <script>
      (async () => {
        const profile = await window.auth.requireAuth();
        if (!profile) return;

        const payBox = document.getElementById('payBox');
        if (!payBox) return;

        // If already paid, show status and go back to dashboard
        if (profile.user?.hasPaid) {
          payBox.innerHTML = `<p style="color:#00ff7f; font-weight:800;">✅ Active Subscription</p>
                              <p style="color:#94a3b8;">Redirecting you back...</p>`;
          setTimeout(() => (window.location.href = 'dashboard.html'), 900);
          return;
        }

        // Not paid → show pay button
        payBox.innerHTML = `
          <p style="color:#ffcc00; font-weight:800;">Payment required</p>
          <button type="button" class="btn" id="payBtn">Pay R12,499 / month</button>
        `;

        document
          .getElementById('payBtn')
          .addEventListener('click', async () => {
            try {
              const token = window.auth.getToken();
              const data = await window.api.createCheckoutRequest(token);
              window.location.href = data.checkoutUrl;
            } catch (e) {
              alert(e.message || 'Checkout failed');
            }
          });
      })();
    </script>
  </body>
</html>
