<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sandile SystemsWorks ‚Äì Dashboard</title>
    <link rel="stylesheet" href="css/styles.css" />
  </head>

  <body>
    <!-- APP LAYOUT -->
    <div class="app-shell">
      <!-- SIDEBAR -->
      <aside class="sidebar">
        <div class="sidebar-top">
          <div class="sidebar-brand">
            <img
              src="images/Untitled design.png"
              alt="Sandile SystemsWorks"
              class="sidebar-logo"
            />
            <span class="sidebar-name">SystemsWorks</span>
          </div>

          <nav class="sidebar-nav">
            <a href="dashboard.html" class="active">Dashboard</a>
            <a href="sector-primary.html">Primary Sector</a>
            <a href="sector-secondary.html">Secondary Sector</a>
            <a href="sector-tertiary.html">Tertiary Sector</a>
            <a href="sector-quaternary.html">Quaternary Sector</a>
            <a href="sector-quinary.html">Quinary Sector</a>
          </nav>
        </div>

        <!-- ACCOUNT -->
        <div class="sidebar-account">
          <button id="accountBtn" class="account-btn">
            <span id="accountAvatar" class="account-avatar">U</span>
            <span id="accountName" class="account-name">Account</span>
          </button>

          <div id="accountMenu" class="account-menu">
            <a href="index.html">üè† Home</a>
            <a href="profile.html">üë§ Profile</a>
            <button id="logoutBtn">üö™ Logout</button>
          </div>
        </div>
      </aside>

      <!-- MAIN CONTENT -->
      <main class="main-content">
        <header class="page-header">
          <h1>Business Calculators</h1>
          <p>
            Welcome, <span id="usernameDisplay">User</span>. Choose a sector to
            begin.
          </p>
        </header>

        <!-- SUBSCRIPTION STATUS -->
        <section id="payBox" class="pay-box"></section>
<!-- SECTORS -->
<section class="cards-grid">
  <div class="card">
    <h3 class="card-title">Primary Sector</h3>
    <p>Agriculture, Mining, Oil & Gas, Renewable Energy</p>
    <a href="sector-primary.html">Explore ‚Üí</a>
  </div>

  <div class="card">
    <h3 class="card-title">Secondary Sector</h3>
    <p>Manufacturing, Construction, Automotive, Electronics</p>
    <a href="sector-secondary.html">Explore ‚Üí</a>
  </div>

  <div class="card">
    <h3 class="card-title">Tertiary Sector</h3>
    <p>Retail, Logistics, Healthcare, Finance, Consulting</p>
    <a href="sector-tertiary.html">Explore ‚Üí</a>
  </div>

  <div class="card">
    <h3 class="card-title">Quaternary Sector</h3>
    <p>Software, SaaS, IT Services, Media, R&D</p>
    <a href="sector-quaternary.html">Explore ‚Üí</a>
  </div>

  <div class="card">
    <h3 class="card-title">Quinary Sector</h3>
    <p>Government, NGOs, Education, Public Services</p>
    <a href="sector-quinary.html">Explore ‚Üí</a>
  </div>
</section>


    <!-- REQUIRED GLOBALS -->
    <script src="js/config.js"></script>
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>

    <!-- DASHBOARD LOGIC -->
    <script>
      (async function initDashboard() {
        try {
          // ===============================
          // 1Ô∏è‚É£ AUTH (single source of truth)
          // ===============================
          const profile = await window.auth.requireAuth();
          if (!profile || !profile.user) return;

          const user = profile.user;
          const now = Date.now();

          // ===============================
          // 2Ô∏è‚É£ HEADER / ACCOUNT UI
          // ===============================
          const usernameEl = document.getElementById('usernameDisplay');
          if (usernameEl) {
            usernameEl.textContent = user.name || 'User';
          }

          const displayName =
            user.name || (user.email ? user.email.split('@')[0] : 'Account');

          const accountName = document.getElementById('accountName');
          const accountAvatar = document.getElementById('accountAvatar');

          if (accountName) accountName.textContent = displayName;
          if (accountAvatar)
            accountAvatar.textContent = displayName.charAt(0).toUpperCase();

          // ===============================
          // 3Ô∏è‚É£ SUBSCRIPTION STATE
          // ===============================
          const payBox = document.getElementById('payBox');
          if (!payBox) return;

          const subscriptionEnd = user.subscriptionEnd
            ? new Date(user.subscriptionEnd).getTime()
            : 0;

          const trialEnd = user.trialEnd
            ? new Date(user.trialEnd).getTime()
            : 0;

          const subActive = subscriptionEnd && subscriptionEnd > now;
          const trialActive = trialEnd && trialEnd > now;

          // ===============================
          // 4Ô∏è‚É£ RENDER UI
          // ===============================
          if (subActive || trialActive) {
            payBox.innerHTML = `
          <p class="status active">
            ${subActive ? '‚úÖ Subscription active' : 'üÜì Trial active'}
          </p>
        `;
          } else {
            payBox.innerHTML = `
          <p class="status expired">üîí Access expired</p>
          <button id="payBtn" class="btn btn-primary">Renew</button>
        `;

            const payBtn = document.getElementById('payBtn');
            payBtn.addEventListener('click', async () => {
              try {
                const token = window.auth.getToken();
                const data = await window.api.createCheckoutRequest(token);

                if (!data || !data.checkoutUrl) {
                  throw new Error('Checkout URL missing');
                }

                window.location.href = data.checkoutUrl;
              } catch (err) {
                alert(err.message || 'Payment initialization failed');
              }
            });
          }
        } catch (err) {
          console.error('Dashboard init failed:', err);
        }
      })();

      // ===============================
      // ACCOUNT DROPDOWN
      // ===============================
      const accountBtn = document.getElementById('accountBtn');
      const accountMenu = document.getElementById('accountMenu');

      if (accountBtn && accountMenu) {
        accountBtn.addEventListener('click', () => {
          accountMenu.classList.toggle('open');
        });

        document.addEventListener('click', (e) => {
          if (!accountBtn.contains(e.target)) {
            accountMenu.classList.remove('open');
          }
        });
      }

      // ===============================
      // LOGOUT
      // ===============================
      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', () => {
          window.auth.logout();
        });
      }
    </script>

    <script>
      const hamburger = document.getElementById('hamburger');
      const sidebar = document.querySelector('.sidebar');
      const backdrop = document.getElementById('mobileBackdrop');

      if (hamburger && sidebar && backdrop) {
        const openMenu = () => {
          sidebar.classList.add('open');
          hamburger.classList.add('active');
          backdrop.classList.remove('hidden');
          document.body.style.overflow = 'hidden';
        };

        const closeMenu = () => {
          sidebar.classList.remove('open');
          hamburger.classList.remove('active');
          backdrop.classList.add('hidden');
          document.body.style.overflow = '';
        };

        // Toggle menu
        hamburger.addEventListener('click', () => {
          sidebar.classList.contains('open') ? closeMenu() : openMenu();
        });

        // Close when clicking backdrop
        backdrop.addEventListener('click', closeMenu);

        // Close when clicking any sidebar link
        sidebar.querySelectorAll('a').forEach((link) => {
          link.addEventListener('click', closeMenu);
        });

        // Safety: reset on resize to desktop
        window.addEventListener('resize', () => {
          if (window.innerWidth > 700) {
            closeMenu();
          }
        });
      }
    </script>
  </body>
</html>
