<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sandile SystemsWorks - Dashboard</title>
    <link rel="stylesheet" href="css/styles.css" />
  </head>

  <body>
    <!-- HEADER -->
    <header class="header">
      <div class="container">
        <div class="header-inner">
          <div class="brand">
            <img
              src="images/Untitled design.png"
              alt="Sandile SystemsWorks"
              class="brand-logo"
            />
            <span class="brand-name">Sandile SystemsWorks</span>
          </div>

          <div class="header-actions">
            <button
              type="button"
              class="btn btn-ghost"
              onclick="window.auth.logout()"
            >
              Logout
            </button>
          </div>
        </div>
      </div>
    </header>

    <main>
      <h1>Business Calculators</h1>
      <p>
        Welcome, <span id="usernameDisplay"></span>. Choose a sector to begin.
      </p>

      <div id="payBox"></div>

      <div class="card" style="margin-top: 16px">
        <h3 style="margin-bottom: 10px">Recently opened calculators</h3>
        <div id="recentList"></div>
      </div>

      <div class="cards-grid">
        <div class="card">
          <h3 class="card-title">Primary Sector</h3>
          <p>
            Agriculture, Forestry, Fishing, Mining, Oil &amp; Gas, Renewable
            Energy
          </p>
          <a href="sector-primary.html">Explore Calculators ‚Üí</a>
        </div>

        <div class="card">
          <h3 class="card-title">Secondary Sector</h3>
          <p>
            Manufacturing, Construction, Automotive, Electronics, Textiles, Food
            &amp; Beverage
          </p>
          <a href="sector-secondary.html">Explore Calculators ‚Üí</a>
        </div>

        <div class="card">
          <h3 class="card-title">Tertiary Sector</h3>
          <p>
            Real Estate, Retail, Restaurants, Hospitality, Logistics,
            Healthcare, Education, Finance, Marketing, Consulting
          </p>
          <a href="sector-tertiary.html">Explore Calculators ‚Üí</a>
        </div>

        <div class="card">
          <h3 class="card-title">Quaternary Sector</h3>
          <p>Software, SaaS, IT Services, Media, R&amp;D, Telecommunications</p>
          <a href="sector-quaternary.html">Explore Calculators ‚Üí</a>
        </div>

        <div class="card">
          <h3 class="card-title">Quinary Sector</h3>
          <p>
            Government, NGOs, Social &amp; Community Services, Public
            Administration
          </p>
          <a href="sector-quinary.html">Explore Calculators ‚Üí</a>
        </div>
      </div>
    </main>

    <!-- REQUIRED GLOBALS (ORDER MATTERS) -->
    <script src="js/config.js"></script>
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>

    <script>
      (async () => {
        const profile = await window.auth.requireAuth();
        if (!profile) return;

        const el = document.getElementById('usernameDisplay');
        if (el) el.textContent = profile.user?.name || 'User';

        const payBox = document.getElementById('payBox');
        if (!payBox) return;

        if (profile.user?.hasPaid) {
          payBox.innerHTML =
            '<p style="color:#00ff7f;">‚úÖ Active Subscription</p>';
          return;
        }

        payBox.innerHTML = `
          <p style="color:#ffcc00;">Trial active or payment required.</p>
          <button type="button" class="btn btn-primary" id="payBtn">
            Pay now
          </button>
        `;

        document
          .getElementById('payBtn')
          .addEventListener('click', async () => {
            try {
              const token = window.auth.getToken();
              const data = await window.api.createCheckoutRequest(token);
              window.location.href = data.checkoutUrl;
            } catch (e) {
              alert(e.message || 'Payment initialization failed');
            }
          });
      })();
    </script>
    <script>
      function formatRemaining(ms) {
        const totalSeconds = Math.max(0, Math.floor(ms / 1000));
        const days = Math.floor(totalSeconds / 86400);
        const hours = Math.floor((totalSeconds % 86400) / 3600);
        const mins = Math.floor((totalSeconds % 3600) / 60);
        return `${days}d ${hours}h ${mins}m`;
      }

      function dateFmt(d) {
        return new Date(d).toLocaleString();
      }

      function pickActiveEnd(user) {
        const now = Date.now();

        const subEnd = user.subscriptionEnd
          ? new Date(user.subscriptionEnd).getTime()
          : 0;
        if (subEnd && subEnd > now) return { type: 'sub', end: subEnd };

        const trialEnd = user.trialEnd ? new Date(user.trialEnd).getTime() : 0;
        if (trialEnd && trialEnd > now) return { type: 'trial', end: trialEnd };

        return null;
      }

      function esc(s) {
        return String(s).replace(
          /[&<>"']/g,
          (m) =>
            ({
              '&': '&amp;',
              '<': '&lt;',
              '>': '&gt;',
              '"': '&quot;',
              "'": '&#039;',
            })[m]
        );
      }

      function renderRecents(recents) {
        const el = document.getElementById('recentList');
        if (!el) return;

        if (!recents || recents.length === 0) {
          el.innerHTML = `<p style="color:#777;">No calculators opened yet.</p>`;
          return;
        }

        el.innerHTML = recents
          .map(
            (c) => `
    <a href="${esc(c.url)}"
       style="display:block;padding:12px;border:1px solid #222;border-radius:12px;margin:10px 0;text-decoration:none;">
      <div style="color:#fff;font-weight:700;">${esc(c.title)}</div>
      <div style="color:#777;font-size:.9rem;">Last opened: ${new Date(c.lastOpenedAt).toLocaleString()}</div>
    </a>
  `
          )
          .join('');
      }

      async function renderDashboard() {
        const payBox = document.getElementById('payBox');

        const token = window.auth.getToken();
        const profile = await window.api.getProfile(token); // must call /api/auth/profile (your route)
        const user = profile.user;

        // ‚úÖ TIMER UI
        const active = pickActiveEnd(user);

        if (!active) {
          payBox.innerHTML = `
      <p style="color:#ff4d4d;">üîí Access expired</p>
      <button class="btn btn-primary" id="payBtn">Renew</button>
    `;
        } else {
          const label =
            active.type === 'sub'
              ? '‚úÖ Subscription active'
              : 'üÜì Trial active';

          payBox.innerHTML = `
      <p style="color:#00ff7f;">${label}</p>
      <p style="color:#ccc;">‚è≥ Remaining: <span id="timeLeft"></span></p>
      <p style="color:#777;">Expires: ${dateFmt(active.end)}</p>
      <button class="btn btn-primary" id="payBtn">Upgrade / Renew</button>
    `;

          const el = document.getElementById('timeLeft');
          const tick = () =>
            (el.textContent = formatRemaining(active.end - Date.now()));
          tick();
          setInterval(tick, 1000 * 30);
        }

        // ‚úÖ PAY BUTTON always works
        document
          .getElementById('payBtn')
          .addEventListener('click', async () => {
            try {
              const token = window.auth.getToken();
              const data = await window.api.createCheckoutRequest(token);
              window.location.href = data.checkoutUrl;
            } catch (e) {
              alert(e.message || 'Payment initialization failed');
            }
          });

        // ‚úÖ RECENTS UI (navigates via links)
        renderRecents(user.recentCalculators);
      }

      renderDashboard().catch(console.error);
    </script>
  </body>
</html>
